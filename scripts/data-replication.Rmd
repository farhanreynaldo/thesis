---
title: "Data exploration"
author: "Farhan Reynaldo"
date: "2024-09-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
here::i_am("scripts/data-replication.Rmd")
```

```{r}
library(tidyverse)
library(haven)
library(here)
library(rstanarm)
library(ipumsr)
library(ggtext)

options(mc.cores = parallel::detectCores())
```

```{r}
load("../../election_stan_analysis/Stan MRP R Code/stan-MRP-20120715.RData")
```

## Replicate stan result

```{r}
i.year <- 2
years <- c(2004, 2008)
tmp <- dat.vot[dat.vot$year==years[i.year],]
tmp$grp <- apply(tmp[, c("stt", "eth", "inc", "age")], 1, paste, collapse = "_")
tmp$ones <- 1
tmp <- rename(tmp,vote = rvote)
data_matrix <- calc_and_add_weighted_results(data_matrix, tmp)
reg_formula <- as.formula(build_formula(level = 3))

start.time <- Sys.time()
mod <- stan_glmer(reg_formula,
  data = data_matrix, family = binomial(link = "logit"),
  iter = 500
)
end.time <- Sys.time()
time.taken <- end.time - start.time

pred <- posterior_epred(mod, newdata = data_matrix)
```

```{r}
reg_formula <- "yes | trials(yes+no) ~ z_inc*z_incstt + z_inc*z_trnprv + (1 + z_inc | reg) + (1 + z_inc | stt) + (1 + z_inc | eth) + (1 | inc) + (1 + z_inc | age) + (1 | reg : eth) + (1 | reg : inc) + (1 | reg : age) + (1 | stt : eth) + (1 | stt : inc) + (1 | stt : age) + (1 | eth : inc) + (1 | eth : age) + (1 | inc : age) + (1 | stt : eth : inc) + (1 | stt : eth : age) + (1 | stt : inc : age) + (1 | eth : inc : age)"

mod <- brms::brm(as.formula(reg_formula),
  data = data_matrix, family = binomial(link = "logit"),
  iter = 500
)
```


```{r}
data_matrix %>% 
  mutate(pred = colMeans(pred)) %>% 
  group_by(stt, inc) %>% 
  summarise(
    pred_all = sum(pred * pop2008) / sum(pop2008), 
    pred_white = sum(pred[eth == 1] * pop2008[eth == 1]) / sum(pop2008[eth == 1])
  ) %>% 
  ungroup() %>% 
   mutate(
    state_name = state.names[stt],
    state_abb = stt.label[stt]
  ) %>%
  filter(!state_abb %in% c("AK", "HI", "DC")) %>%
  left_join(select(dat.stt, state, rep2008), by = c("state_abb" = "state")) %>%
  mutate(state_name = fct_reorder(state_name, rep2008, .desc = TRUE)) %>% 
  ggplot(aes(group = 1)) +
  geom_line(aes(x = inc, y = pred_all, color = "grey")) + 
  geom_line(aes(x = inc, y = pred_white, color = "orange")) + 
  scale_x_discrete(labels = c("poor", "", "mid", "", "rich")) +
  scale_y_continuous(labels = scales::label_percent(), breaks = seq(0, 1, 0.5)) +
  scale_color_identity() +
  labs(x = "", y = "") +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~state_name, ncol = 7) +
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(0, 0, 20, 0)),
    plot.caption = element_text(hjust = 0.5, margin = margin(10, 0, 0, 0)),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_text(size = 10),
    legend.position = "none"
  )
```

## Replicate figure 2

```{r}
data_matrix <- data_matrix %>%
  mutate(plot.grp = paste(stt, inc, sep = "_"))

D2 <- data_matrix %>%
  group_by(plot.grp) %>%
  summarize(
    vote2008 = sum(vote2008 * pop2008) / sum(pop2008),
    vote2004 = sum(vote2004 * pop2004) / sum(pop2004),
    stt = unique(stt),
    inc = unique(inc)
  )

D3 <- data_matrix %>%
  filter(eth == 1) %>%
  group_by(plot.grp) %>%
  summarize(
    vote2008 = sum(vote2008 * pop2008) / sum(pop2008),
    vote2004 = sum(vote2004 * pop2004) / sum(pop2004),
    stt = unique(stt),
    inc = unique(inc)
  )

stt.inc <- expand.grid(stt = sort(unique(D2$stt)), inc = sort(unique(D2$inc))) %>%
  mutate(
    fit1 = NA, se1 = NA, mu1 = NA,
    fit2 = NA, se2 = NA, mu2 = NA
  )

for (i in seq_len(nrow(stt.inc))) {
  # Filter based on stt and inc
  filter_cond <- dat.vot$stt == stt.inc$stt[i] & dat.vot$inc == stt.inc$inc[i] & dat.vot$year == 2008
  ok <- which(filter_cond)
  if (length(ok) > 1) {
    stt.inc$fit1[i] <- D2$vote2008[D2$stt == stt.inc$stt[i] & D2$inc == stt.inc$inc[i]]
    stt.inc$mu1[i] <- min(0.98, max(0.02, weighted.mean(dat.vot$rvote[ok], w = dat.vot$weight[ok])))
    stt.inc$se1[i] <- sqrt((stt.inc$fit1[i] * (1 - stt.inc$fit1[i])) / length(ok))
  }

  ok <- which(filter_cond & dat.vot$eth == 1)
  if (length(ok) > 1) {
    stt.inc$fit2[i] <- D3$vote2008[D3$stt == stt.inc$stt[i] & D3$inc == stt.inc$inc[i]]
    stt.inc$mu2[i] <- min(0.98, max(0.02, weighted.mean(dat.vot$rvote[ok], w = dat.vot$weight[ok])))
    stt.inc$se2[i] <- sqrt((stt.inc$fit2[i] * (1 - stt.inc$fit2[i])) / length(ok))
  }
}
```

```{r, fig.width=10, fig.height=10, warning=FALSE}
title <- "2008 election:  McCain share of the two-party vote in each income category\nwithin each state among all voters (gray) and just non-Hispanic whites (orange)"
caption <- "Dots are weighted averages from pooled June-Nov Pew surveys; error bars show +/- 1 s.e. bounds.\n Curves are estimated using multilevel models and have a s.e. of about 3% at each point.\n States are ordered in decreasing order of McCain vote (Alaska, Hawaii, and D.C. excluded)"


stt.inc %>%
  mutate(
    state_name = state.names[stt],
    state_abb = stt.label[stt]
  ) %>%
  filter(!state_abb %in% c("AK", "HI", "DC")) %>%
  left_join(select(dat.stt, state, rep2008), by = c("state_abb" = "state")) %>%
  mutate(state_name = fct_reorder(state_name, rep2008, .desc = TRUE)) %>%
  ggplot(aes(group = 1)) +
  geom_line(aes(x = inc, y = fit1, color = "grey")) +
  geom_line(aes(x = inc, y = fit2, color = "orange")) +
  geom_pointrange(aes(x = as.numeric(inc), y = mu1, ymin = mu1 - se1, ymax = mu1 + se1, color = "grey"), fatten = 0.001, linewidth = 0.3) +
  geom_pointrange(aes(x = as.numeric(inc) + 0.1, y = mu2, ymin = mu2 - se2, ymax = mu2 + se2, color = "orange"), fatten = 0.001, linewidth = 0.3) +
  geom_hline(aes(yintercept = 0.5), color = "grey80", size = 0.2) +
  scale_x_discrete(labels = c("poor", "", "mid", "", "rich")) +
  scale_y_continuous(labels = scales::label_percent(), breaks = seq(0, 1, 0.5)) +
  scale_colour_identity() +
  labs(title = title, x = "", y = "", caption = caption) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~state_name, ncol = 7) +
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(0, 0, 20, 0)),
    plot.caption = element_text(hjust = 0.5, margin = margin(10, 0, 0, 0)),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_text(size = 10),
    legend.position = "none"
  )

ggsave("2008_stan_fig2_replicate.jpg", width = 10, height = 10, dpi = 300)
```


```{r}
# data_matrix$plot.grp <- apply(data_matrix[, c("stt", "inc")], 1, paste, collapse = "_")
# D2 <- summarize(group_by(data_matrix, plot.grp), vote2008 = sum(vote2008 * pop2008) / sum(pop2008), vote2004 = sum(vote2004 * pop2004) / sum(pop2004), stt = unique(stt), inc = unique(inc))
# D3 <- summarize(group_by(data_matrix[data_matrix$eth == 1, ], plot.grp), vote2008 = sum(vote2008 * pop2008) / sum(pop2008), vote2004 = sum(vote2004 * pop2004) / sum(pop2004), stt = unique(stt), inc = unique(inc))
#
# # 2008
# stt.inc <- as.data.frame(expand.grid(sort(unique(D2$stt)), sort(unique(D2$inc))))
# colnames(stt.inc) <- c("stt", "inc")
# stt.inc$fit2 <- stt.inc$se2 <- stt.inc$mu2 <-
#   stt.inc$fit1 <- stt.inc$se1 <- stt.inc$mu1 <- NA
#
# for (i in 1:nrow(stt.inc)) {
#   ok <- which(dat.vot$stt == stt.inc$stt[i] & dat.vot$inc == stt.inc$inc[i] & dat.vot$year == 2008)
#   if (length(ok) > 1) {
#     stt.inc$fit1[i] <- D2$vote2008[D2$stt == stt.inc$stt[i] & D2$inc == stt.inc$inc[i]]
#     stt.inc$mu1[i] <- min(0.98, max(0.02, weighted_mean(dat.vot$rvote[ok], w = dat.vot$weight[ok])))
#     stt.inc$se1[i] <- sqrt((stt.inc$fit1[i] * (1 - stt.inc$fit1[i])) / length(ok))
#   }
#   ok <- which(dat.vot$stt == stt.inc$stt[i] & dat.vot$inc == stt.inc$inc[i] & dat.vot$year == 2008 & dat.vot$eth == 1)
#   if (length(ok) > 1) {
#     stt.inc$fit2[i] <- D3$vote2008[D3$stt == stt.inc$stt[i] & D3$inc == stt.inc$inc[i]]
#     stt.inc$mu2[i] <- min(0.98, max(0.02, weighted_mean(dat.vot$rvote[ok], w = dat.vot$weight[ok])))
#     stt.inc$se2[i] <- sqrt((stt.inc$fit2[i] * (1 - stt.inc$fit2[i])) / length(ok))
#   }
# }
#
# png("2008_stan_fig2.png", height = 10, width = 10, res = 300, units = "in")
# graph.dims <- c(7, 7)
# par(
#   mfrow = graph.dims, mar = c(1, 0.75, 1, 0.75), tck = 0, mgp = c(1.5, .5, 0),
#   oma = c(7, 2, 4, 0), lwd = 0.5
# )
# sort.state <- rev(order(dat.stt$rep2008[1:51]))
# state.names <- c(state.name[1:8], "Washington DC", state.name[9:50])
# colors <- c("gray40", "darkorange")
# pchs <- c(20, 21)
# count <- 0
# for (i in sort.state) {
#   if (!(stt.label[i] %in% c("AK", "HI", "DC"))) {
#     count <- count + 1
#     plot(c(1, 5), c(0, 1), xlab = "", ylab = "", xaxt = "n", yaxt = "n", type = "n", yaxs = "i")
#     if (count %% graph.dims[2] == 1) {
#       axis(2, c(.02, .5, .95), c("0%", "50%", "100%"), cex.axis = 1.1, lwd = 0.5)
#     }
#     if (count > (48 - graph.dims[2])) {
#       axis(1, c(1.2, 3, 4.8), c("poor", "mid", "rich"), cex.axis = 1.2, lwd = 0.5)
#     }
#     abline(.5, 0, col = "gray", lwd = .5)
#
#     tmp <- stt.inc[stt.inc$stt == i, ]
#     points(1:5 - 0.05, tmp$mu1, pch = 20, col = colors[1], cex = 0.5)
#     segments(1:5 - 0.05, tmp$mu1 - tmp$se1, 1:5 - 0.05, tmp$mu1 + tmp$se1, col = colors[1])
#     points(1:5, tmp$fit1, type = "l", col = colors[1])
#
#     points(1:5 + 0.05, tmp$mu2, ylim = c(0, 1), pch = 20, col = colors[2], cex = 0.5)
#     segments(1:5 + 0.05, tmp$mu2 - tmp$se2, 1:5 + 0.05, tmp$mu2 + tmp$se2, col = colors[2])
#     points(1:5, tmp$fit2, type = "l", col = colors[2])
#     text(3, .9, state.names[i], cex = 1.3)
#   }
# }
# mtext("2008 election:  McCain share of the two-party vote in each income category\nwithin each state among all voters (gray) and just non-Hispanic whites (orange)", outer = TRUE, cex = 1, side = 3, line = 1)
# mtext(" Dots are weighted averages from pooled June-Nov Pew surveys; error bars show +/- 1 s.e. bounds.\n Curves are estimated using multilevel models and have a s.e. of about 3% at each point.\n States are ordered in decreasing order of McCain vote (Alaska, Hawaii, and D.C. excluded).", outer = TRUE, cex = .9, side = 1, line = 5)
# dev.off()
```
