---
title: "Data visualization"
author: "Farhan Reynaldo"
date: "2024-09-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
here::i_am("scripts/data-modeling.Rmd")


library(rstanarm)
library(tidybayes)
library(ggtext)
library(usmap)
library(sf)
library(tidyverse)
library(here)

source(here::here("src/election.R"))
source(here::here("src/helpers.R"))
source(here::here("src/theme.R"))
source(here::here("src/load_data.R"))

map_data <- usmap::us_map(regions = "states")
poststrat_data <- read_csv(here("data/census-pums-pop-2016.csv")) %>%
  mutate(pop2008 = wtpop)
```


```{r}
year <- 2016
run <- FALSE

states_data <- process_states_data(states_election_data, states_pop_income_data, year)
election_processed <- process_election_data(election_all, year)
covariates <- c("stt", "eth", "inc", "age", "educ", "metro")

data_matrix <- expand.grid(
  stt = factor(1:length(stt.label)),
  eth = factor(1:length(eth.label)),
  inc = factor(1:length(inc.label)),
  age = factor(1:length(age.label)),
  educ = factor(1:length(educ.label)),
  metro = factor(1:length(metro.label))
) %>%
  mutate(
    grp = apply(., 1, paste, collapse = "_"),
    ix = row_number()
  ) %>%
  left_join(states_data, by = c("stt" = "stt")) %>%
  mutate(
    reg = factor(reg.lkup[as.numeric(stt)]),
    z_inc = arm::rescale(as.numeric(inc))
  )

election_subset <- election_processed %>%
  mutate(
    # Vote for Republican
    vote = ifelse(vote == "Republican", 1, 0),
    grp = apply(.[, covariates], 1, paste, collapse = "_"),
    ones = 1
  )

# Calculate and add weighted results
data_matrix <- calc_and_add_weighted_results(data_matrix, election_subset)

# Build and fit model
reg_formula <- "cbind(yes, no) ~ z_inc*z_incstt + z_inc*z_trnprv +
(1 + z_inc | reg) + (1 + z_inc | stt) + (1 + z_inc | eth)  + (1 + z_inc | educ) + (1 + z_inc | age) + (1 + z_inc | metro) + (1 | inc) + (1 | reg : eth) + (1 | reg : inc) + (1 | reg : age) + (1 | reg : metro) + (1 | stt : eth) + (1 | stt : inc) + (1 | stt : age) + (1 | stt : metro) + (1 | eth : inc) + (1 | eth : age) + (1 | eth : metro) + (1 | inc : age) + (1 | inc : metro) + (1 | educ : age) + (1 | educ : stt) + (1 | educ : inc) + (1 | educ : eth) + (1 | educ : reg) + (1 | educ : metro)"


if (run == TRUE) {
  model <- stan_glmer(reg_formula,
    data = data_matrix,
    family = binomial(link = "logit"), iter = 500
  )

  pred <- posterior_epred(model, newdata = data_matrix)
  model_matrix <- list(model = model, data_matrix = data_matrix, pred = pred)
  saveRDS(model_matrix, here("data/model_matrix_complete_2020.rds"))
}
```

```{r}
launch_shinystan(model, ppd = F)
```


```{r, fig.width = 10, fig.height = 10}
model_matrix <- readRDS(here("data/model_matrix_complete_2016.rds"))
model <- model_matrix$model
data_matrix <- model_matrix$data_matrix

# Poststratification
result <- poststrat_data %>%
  mutate(grp = apply(.[, c("stt", "eth", "inc", "age", "educ", "metro")], 1, paste, collapse = "_")) %>%
  group_by(grp) %>%
  summarise(
    pop2008 = sum(wtpop, na.rm = TRUE)
  ) %>%
  right_join(data_matrix, by = "grp") %>%
  arrange(ix)

# Plot results
plot_result <- result %>%
  mutate(pred = colMeans(model_matrix$pred)) %>%
  group_by(stt, educ) %>%
  summarise(
    pred_all = sum(pred * pop2008, na.rm = TRUE) / sum(pop2008, na.rm = TRUE),
    pred_white = sum(pred[eth == 1] * pop2008[eth == 1]) / sum(pop2008[eth == 1]),
    se_all = sqrt((pred_all * (1 - pred_all)) / sum(n)),
    se_white = sqrt((pred_white * (1 - pred_white)) / sum(n[eth == 1]))
  ) %>%
  ungroup() %>%
  left_join(stt_dict, by = c("stt" = "stt")) %>%
  dplyr::filter(!state_abbr %in% c("AK", "HI", "DC")) %>%
  left_join(states_data %>% dplyr::filter(year == year) %>% dplyr::select(state_abbr, rep_votes), by = c("state_abbr" = "state_abbr")) %>%
  mutate(state_name = fct_reorder(state_name, rep_votes, .desc = TRUE)) %>%
  arrange(-rep_votes) %>%
  left_join(election_subset, by = c("stt", "educ"))

title <- "2020 Election: Republican vote share for each education level across states\namong all voters (grey) and white voters (orange)"

plot_result %>%
  ggplot(aes(group = 1)) +
  geom_line(aes(x = educ, y = pred_all, color = "grey")) +
  geom_line(aes(x = educ, y = pred_white, color = "orange")) +
  geom_hline(aes(yintercept = 0.5), color = "grey80", linewidth = 0.2) +
  scale_y_continuous(labels = scales::label_percent(), breaks = seq(0, 1, 0.5)) +
  scale_color_identity() +
  labs(title = title, x = "", y = "") +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~state_name, ncol = 7) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 6),
    plot.title = element_text(hjust = 0.5, margin = margin(0, 0, 20, 0)),
    plot.caption = element_text(hjust = 0.5, margin = margin(10, 0, 0, 0)),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_text(size = 10),
    legend.position = "none"
  )
```


```{r, fig.width = 10, fig.height = 10}
# Plot results
plot_result <- result %>%
  mutate(pred = colMeans(model_matrix$pred)) %>%
  group_by(stt, inc) %>%
  summarise(
    pred_all = sum(pred * pop2008, na.rm = TRUE) / sum(pop2008, na.rm = TRUE),
    pred_white = sum(pred[eth == 1] * pop2008[eth == 1]) / sum(pop2008[eth == 1]),
    se_all = sqrt((pred_all * (1 - pred_all)) / sum(n)),
    se_white = sqrt((pred_white * (1 - pred_white)) / sum(n[eth == 1]))
  ) %>%
  ungroup() %>%
  left_join(stt_dict, by = c("stt" = "stt")) %>%
  dplyr::filter(!state_abbr %in% c("AK", "HI", "DC")) %>%
  left_join(states_data %>% dplyr::filter(year == year) %>% dplyr::select(state_abbr, rep_votes), by = c("state_abbr" = "state_abbr")) %>%
  mutate(state_name = fct_reorder(state_name, rep_votes, .desc = TRUE)) %>%
  arrange(-rep_votes) %>%
  left_join(election_subset, by = c("stt", "inc"))

title <- "2020 Election: Republican vote share for each education level across states\namong all voters (grey) and white voters (orange)"

plot_result %>%
  ggplot(aes(group = 1)) +
  geom_line(aes(x = inc, y = pred_all, color = "grey")) +
  geom_line(aes(x = inc, y = pred_white, color = "orange")) +
  geom_hline(aes(yintercept = 0.5), color = "grey80", linewidth = 0.2) +
  scale_y_continuous(labels = scales::label_percent(), breaks = seq(0, 1, 0.5)) +
  scale_color_identity() +
  labs(title = title, x = "", y = "") +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~state_name, ncol = 7) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 6),
    plot.title = element_text(hjust = 0.5, margin = margin(0, 0, 20, 0)),
    plot.caption = element_text(hjust = 0.5, margin = margin(10, 0, 0, 0)),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_text(size = 10),
    legend.position = "none"
  )
```


```{r}
result %>%
  mutate(pred = colMeans(model_matrix$pred)) %>%
  group_by(inc, educ) %>%
  summarise(
    pred_all = sum(pred * pop2008, na.rm = TRUE) / sum(pop2008, na.rm = TRUE),
    se_all = sqrt((pred_all * (1 - pred_all)) / sum(n)),
  ) %>%
  ungroup() %>%
  ggplot(aes(inc, pred_all, group = educ, color = educ)) +
  geom_line()
```


```{r}
result %>%
  mutate(pred = colMeans(model_matrix$pred)) %>%
  group_by(inc, educ) %>%
  summarise(
    pred_all = sum(pred * pop2008, na.rm = TRUE) / sum(pop2008, na.rm = TRUE),
    se_all = sqrt((pred_all * (1 - pred_all)) / sum(n)),
  ) %>%
  ungroup() %>%
  ggplot(aes(educ, pred_all, group = inc, color = inc)) +
  geom_line()
```

```{r, fig.width = 10, fig.height = 10}
result %>%
  mutate(pred = colMeans(model_matrix$pred)) %>%
  mutate(educ = if_else(educ %in% c(1, 2, 3), "No college", "College")) %>%
  group_by(stt, educ, inc) %>%
  summarise(
    pred_all = sum(pred * pop2008, na.rm = TRUE) / sum(pop2008, na.rm = TRUE),
    se_all = sqrt((pred_all * (1 - pred_all)) / sum(n))
  ) %>%
  ungroup() %>%
  left_join(stt_dict, by = c("stt" = "stt")) %>%
  dplyr::filter(!state_abbr %in% c("AK", "HI", "DC")) %>%
  left_join(states_data %>% dplyr::filter(year == year) %>% dplyr::select(state_abbr, rep_votes), by = c("state_abbr" = "state_abbr")) %>%
  mutate(state_name = fct_reorder(state_name, rep_votes, .desc = TRUE)) %>%
  arrange(-rep_votes) %>%
  ggplot(aes(educ, pred_all, group = inc, color = inc)) +
  geom_line() +
  geom_hline(aes(yintercept = 0.5), color = "grey80", linewidth = 0.2) +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~state_name, ncol = 7) +
  # scale_color_manual(values = c("No college" = "grey", "College" = "orange")) +
  theme_classic() +
  theme(
    axis.text.x = element_text(size = 6),
    plot.title = element_text(hjust = 0.5, margin = margin(0, 0, 20, 0)),
    plot.caption = element_text(hjust = 0.5, margin = margin(10, 0, 0, 0)),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_text(size = 10)
  )
```
