---
title: "Data exploration"
author: "Farhan Reynaldo"
date: "2024-09-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
here::i_am("scripts/data-exploration.Rmd")
```

```{r}
library(tidyverse)
library(haven)
library(janitor)
library(here)
library(rstanarm)
library(lme4)
library(ipumsr)
library(ggtext)
library(table1)

source(here("src/load_data.R"))
source(here("src/election.R"))
source(here("src/theme.R"))

options(mc.cores = parallel::detectCores())
```

```{r}
# Define constants
reg.lkup <- c(3, 4, 4, 3, 4, 4, 1, 1, 5, 3, 3, 4, 4, 2, 2, 2, 2, 3, 3, 1, 1, 1, 2, 2, 3, 2, 4, 2, 4, 1, 1, 4, 1, 3, 2, 2, 3, 4, 1, 1, 3, 2, 3, 3, 4, 1, 3, 4, 1, 2, 4)
stt.label <- c(state.name[1:8], "DC", state.name[9:50])
stt.abb.label <- c(state.abb[1:8], "DC", state.abb[9:50])
eth.label <- c("White", "Black", "Hispanic", "Other")
inc.label <- c("$0-20k", "$20-40k", "$40-75k", "$75-150k", "$150k+")
age.label <- c("18-29", "30-44", "45-64", "65+")
sex.label <- c("Male", "Female")
edu.label <- c("< HS", "HS", "Some College", "College", "Post-Grad")
```

## 2008 Election

```{r}
election_data %>% 
  count(inc_cces = as_factor(faminc)) %>% 
  mutate(prop = n/sum(n)) %>% 
  filter(!inc_cces %in% c(NA, "Skipped", "Prefer not to say")) %>% 
  ggplot(aes(prop, inc_cces)) + 
  geom_col() + 
  scale_x_continuous(labels = scales::percent, expand = c(0, 0.01)) +
  labs(title = "Income categories distribution in CCES dataset", 
       x = "", y = "") +
  theme_benedict() + 
  theme(axis.text.y = element_text(size = 10))

ggsave("../figures/income_distribution.jpg", width = 10, height = 7)
```

```{r}
election_data %>% 
  count(race = as_factor(race)) %>% 
  mutate(prop = n/sum(n)) %>% 
  ggplot(aes(prop, race)) + 
  geom_col() + 
  scale_x_continuous(labels = scales::percent, expand = c(0, 0.01)) +
  labs(title = "Race categories distribution in CCES dataset", 
       x = "", y = "") +
  theme_benedict() + 
  theme(axis.text.y = element_text(size = 10))

ggsave("../figures/race_distribution.jpg", width = 10, height = 7)
```

```{r}
election_data %>% 
  filter(year %in% seq(2008, 2020, 4)) %>% 
  table1(~ as_factor(sex) + as_factor(educ) + as_factor(race)
         | as_factor(year), data = .)
```


```{r}
census_data %>% 
  filter(YEAR %in% seq(2008, 2020, 4)) %>% 
  table1(~ as_factor(SEX) + as_factor(EDUC) + as_factor(RACE)
         | as_factor(YEAR), data = .)
```


### Preprocess CCES 2008 Election

```{r}
election_2008 <- election_data %>%
  filter(year == 2008) %>%
  select(case_id, state, gender, age, race, educ, faminc, voted_pres_08, weight) %>%
  mutate(
    income_group = factor(
      case_when(
        faminc %in% 1:2 ~ inc.label[1],
        faminc %in% 3:4 ~ inc.label[2],
        faminc %in% 5:7 ~ inc.label[3],
        faminc %in% 8:11 ~ inc.label[4],
        faminc == 12 ~ inc.label[5],
        TRUE ~ NA_character_
      ),
      levels = inc.label
    ),
    age_group = factor(
      case_when(
        age %in% 18:29 ~ age.label[1],
        age %in% 30:44 ~ age.label[2],
        age %in% 45:64 ~ age.label[3],
        age >= 65 ~ age.label[4],
        TRUE ~ NA_character_,
      ),
      levels = age.label,
      ordered = TRUE
    ),
    educ_group = factor(
      case_when(
        educ == 1 ~ edu.label[1],
        educ == 2 ~ edu.label[2],
        educ == 3 ~ edu.label[3],
        educ %in% 4:5 ~ edu.label[4],
        educ == 6 ~ edu.label[5],
        TRUE ~ NA_character_
      ),
      levels = edu.label
    ),
    race = factor(if_else(!race %in% 1:3, "Other", as_factor(race))),
    sex = as_factor(gender),
    state = as_factor(state), 
    state = if_else(state == "District of Columbia", "DC", state),
    income_lab = labelled(income_group)
  ) %>%
  mutate(vote_rep = case_when(
    voted_pres_08 == 2 ~ 1,
    voted_pres_08 == 1 ~ 0,
    TRUE ~ NA_real_
  )) %>%
  drop_na(vote_rep, income_group)
```

```{r}
election_2008 %>%
  mutate(
    income_group = factor(
      case_when(
        faminc %in% 1:2 ~ inc.label[1],
        faminc %in% 3:4 ~ inc.label[2],
        faminc %in% 5:7 ~ inc.label[3],
        faminc %in% 8:11 ~ inc.label[4],
        faminc == 12 ~ inc.label[5],
        TRUE ~ NA_character_
      ),
      levels = inc.label
    ),
    vote_repub = case_when(
      voted_pres_08 == 2 ~ 1,
      voted_pres_08 == 1 ~ 0,
      TRUE ~ NA_real_
    )
  ) %>%
  drop_na(income_group, vote_repub) %>%
  group_by(income_group) %>%
  summarise(vote_repub = mean(vote_repub)) %>%
  ungroup() %>%
  ggplot(aes(income_group, vote_repub, group = 1)) +
  geom_line()
```


```{r}
election_income <- election_2008 %>%
  mutate(
    vote_major = case_when(
      voted_pres_08 == 1 ~ "Obama",
      voted_pres_08 == 2 ~ "McCain",
      TRUE ~ NA_character_
    )
  ) %>%
  drop_na(income_group) %>%
  filter(race == "White") %>%
  mutate(
    vote_rep = if_else(vote_major == "McCain", 1, 0),
    state = as_factor(state)
  ) %>%
  group_by(state, income_group) %>%
  summarise(vote_rep = mean(vote_rep)) %>%
  ungroup()


color_map <- c(
  "Connecticut" = "red", "Ohio" = "blue",
  "Mississippi" = "green", "Other" = "grey"
)

election_income %>%
  mutate(highlight = case_when(
    state == "Connecticut" ~ "Connecticut",
    state == "Ohio" ~ "Ohio",
    state == "Mississippi" ~ "Mississippi",
    TRUE ~ "Other"
  )) %>%
  ggplot(aes(income_group, vote_rep, group = state, color = highlight)) +
  geom_line(data = . %>% filter(highlight == "Other"), alpha = 0.5, linewidth = 0.8) +
  geom_line(data = . %>% filter(highlight != "Other"), linewidth = 0.8) +
  scale_colour_manual(values = color_map) +
  theme_minimal()
```


