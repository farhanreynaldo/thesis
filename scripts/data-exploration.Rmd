---
title: "Data exploration"
author: "Farhan Reynaldo"
date: "2024-09-26"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
here::i_am("scripts/data-exploration.Rmd")
```

## Load library and data

```{r}
library(tidyverse)
library(haven)
library(arrow)
library(here)
library(rstanarm)
library(lme4)
library(ipumsr)
library(ggtext)
library(table1)

source(here("src/load_data.R"))
source(here("src/election.R"))
source(here("src/theme.R"))

options(mc.cores = parallel::detectCores())
```

```{r}
# Define constants
reg.lkup <- c(3, 4, 4, 3, 4, 4, 1, 1, 5, 3, 3, 4, 4, 2, 2, 2, 2, 3, 3, 1, 1, 1, 2, 2, 3, 2, 4, 2, 4, 1, 1, 4, 1, 3, 2, 2, 3, 4, 1, 1, 3, 2, 3, 3, 4, 1, 3, 4, 1, 2, 4)
stt.label <- c(state.name[1:8], "DC", state.name[9:50])
stt.abb.label <- c(state.abb[1:8], "DC", state.abb[9:50])
eth.label <- c("White", "Black", "Hispanic", "Other")
inc.label <- c("$0-20k", "$20-40k", "$40-75k", "$75-150k", "$150k+")
age.label <- c("18-29", "30-44", "45-64", "65+")
sex.label <- c("Male", "Female")
educ.label <- c("< HS", "HS", "Some College", "College", "Post-Grad")

# Create state dictionary
stt_dict <- data.frame(
  state_name = stt.label, state_abbr = stt.abb.label, stt = factor(1:51)
)
```

## 2008 Election

```{r}
election_all %>% 
  count(inc_cces = as_factor(faminc)) %>% 
  mutate(prop = n/sum(n)) %>% 
  filter(!inc_cces %in% c(NA, "Skipped", "Prefer not to say")) %>% 
  ggplot(aes(prop, inc_cces)) + 
  geom_col() + 
  scale_x_continuous(labels = scales::percent, expand = c(0, 0.01)) +
  labs(title = "Income categories distribution in CCES dataset", 
       x = "", y = "") +
  theme_benedict() + 
  theme(axis.text.y = element_text(size = 10))

ggsave("../figures/income_distribution.jpg", width = 10, height = 7)
```

```{r}
election_all %>% 
  count(race = as_factor(race)) %>% 
  mutate(prop = n/sum(n)) %>% 
  ggplot(aes(prop, race)) + 
  geom_col() + 
  scale_x_continuous(labels = scales::percent, expand = c(0, 0.01)) +
  labs(title = "Race categories distribution in CCES dataset", 
       x = "", y = "") +
  theme_benedict() + 
  theme(axis.text.y = element_text(size = 10))

ggsave("../figures/race_distribution.jpg", width = 10, height = 7)
```

```{r}
election_all %>% 
  filter(year %in% seq(2008, 2020, 4)) %>% 
  table1(~ as_factor(sex) + as_factor(educ) + as_factor(race)
         | as_factor(year), data = .)
```


```{r}
# ipums_data %>%
#   filter(YEAR %in% seq(2008, 2020, 4)) %>%
#   table1(~ as_factor(SEX) + as_factor(EDUC) + as_factor(RACE) | as_factor(YEAR),
#          data = .)
```


## Election exploration

```{r}
election_all %>% 
  filter(year %in% seq(2008, 2020, 4)) %>%
  rename(vote = voted_pres_party) %>% 
  group_by(year, vote) %>% 
  summarise(n = n(), .groups = "drop_last") %>% 
  mutate(prop = n/sum(n)) %>% 
  ungroup() %>% 
  pivot_wider(id_cols = -prop, names_from = year, values_from = n)
  # pivot_wider(id_cols = -n, names_from = year, values_from = prop)
```


```{r}
election_all %>% 
  filter(year %in% seq(2008, 2020, 4)) %>%
  rename(vote = voted_pres_party) %>% 
  janitor::tabyl(vote, year) %>% 
  janitor::adorn_totals("row") %>% 
  janitor::adorn_percentages("col") %>% 
  janitor::adorn_pct_formatting(digits = 2) %>% 
  janitor::adorn_ns() %>% 
  knitr::kable()
```

```{r}
election_2012 <- process_election_data(election_all, 2012) %>% 
  mutate(rvote = if_else(vote == "Republican", 1, 0)) 
election_2016 <- process_election_data(election_all, 2016) %>% 
  mutate(rvote = if_else(vote == "Republican", 1, 0)) 
election_2020 <- process_election_data(election_all, 2020) %>% 
  mutate(rvote = if_else(vote == "Republican", 1, 0)) 

election_2012_agg <- election_2020 %>% 
  filter(eth == 1) %>% 
  group_by(inc, stt) %>% 
  summarise(n = n(),
            wt_ybar = sum(rvote*weight)/sum(weight),
            cell_design_eff = 1 + var(weight/mean(weight)),
            .groups = "drop")

design_eff <- weighted_mean(election_2012_agg$cell_design_eff, election_2012_agg$n, election_2012_agg$n > 1)
election_2012_agg$n_eff <- election_2012_agg$n/design_eff
election_2012_agg$wt_ybar[election_2012_agg$n_eff==0] <- 0.5
election_2012_agg <- mutate(election_2012_agg,
                        yes = round(wt_ybar * n_eff),
                        no = round((1 - wt_ybar) * n_eff),
                        n_eff = yes + no)

model_2012 <- stan_glmer(cbind(yes, no) ~ inc + (1 + inc | stt), 
                         data=election_2012_agg, iter = 500, 
                         family=binomial, verbose = TRUE)

stt.inc.df <- expand.grid(stt=factor(1:51), inc=factor(1:5))
pred <- colMeans(posterior_epred(model_2012, stt.inc.df))
stt.inc.df %>% 
  mutate(pred = pred) %>% 
  left_join(stt_dict, by = c("stt" = "stt")) %>% 
  ggplot(aes(x = inc, y = pred, color = state_name, group = state_name)) +
  geom_line(data = . %>% filter(!state_abbr %in% c("MS", "UT", "CT")), color = "grey80", linewidth = 0.8) + 
  geom_line(data = . %>% filter(state_abbr %in% c("MS", "UT", "CT")), color = "orange", linewidth = 0.8) +
  geom_text(data = . %>% filter(state_abbr %in% c("MS", "UT", "CT"), inc == max(as.numeric(inc))), aes(label = state_abbr), color = "orange", hjust = 0, nudge_x = 0.1) +
  theme_classic()
```

```{r}
dat.vot <- read.table(here("data/votechoice2000-04-08.dat"), header=T, sep="\t")
dat.vot$weight[is.na(dat.vot$weight)] <- 1
ok <- apply(is.na(dat.vot[1:8]), 1, sum)==0 & 
      (dat.vot$cit==1 | is.na(dat.vot$cit)) & 
      (dat.vot$regist=="registered" | is.na(dat.vot$regist))
dat.vot <- dat.vot[ok,]
dat.vot$reg <- reg.lkup[dat.vot$stt]
dat.vot$year <- car::recode(dat.vot$file, "'2000-ann'=2000; '2004-ann'=2004; '2008-pew'=2008")
dat.vot <- dat.vot[dat.vot$year != 2000,]

election_2012_agg <- dat.vot %>% 
  filter(eth == 1) %>% 
  group_by(inc, stt) %>% 
  summarise(n = n(),
            wt_ybar = sum(rvote*weight)/sum(weight),
            cell_design_eff = 1 + var(weight/mean(weight)),
            .groups = "drop")

design_eff <- weighted_mean(election_2012_agg$cell_design_eff, election_2012_agg$n, election_2012_agg$n > 1)
election_2012_agg$n_eff <- election_2012_agg$n/design_eff
election_2012_agg$wt_ybar[election_2012_agg$n_eff==0] <- 0.5
election_2012_agg <- mutate(election_2012_agg,
                        yes = round(wt_ybar * n_eff),
                        no = round((1 - wt_ybar) * n_eff),
                        n_eff = yes + no)

model_2012 <- stan_glmer(cbind(yes, no) ~ inc + (1 + inc | stt), 
                         data=election_2012_agg, iter = 2000, 
                         family=binomial, verbose = TRUE)

M2 <- stan_glmer(rvote ~ inc + (1 + inc | stt), weights=weight, data=dat.vot, 
            subset=dat.vot$file=="2008-pew" & dat.vot$eth==1, iter = 500,
             family=binomial, verbose = T)

stt.inc.df <- expand.grid(stt=1:51, inc=1:5)
pred <- colMeans(posterior_epred(model_2012, stt.inc.df))
stt.inc.df %>% 
  mutate(
    stt = factor(stt),
    pred = pred) %>% 
  left_join(stt_dict, by = c("stt" = "stt")) %>% 
  ggplot(aes(x = inc, y = pred, color = state_name, group = state_name)) +
  geom_line(data = . %>% filter(!state_abbr %in% c("MS", "UT", "CT")), color = "grey80", linewidth = 0.8) + 
  geom_line(data = . %>% filter(state_abbr %in% c("MS", "UT", "CT")), color = "orange", linewidth = 0.8) +
  geom_text(data = . %>% filter(state_abbr %in% c("MS", "UT", "CT"), inc == max(as.numeric(inc))), aes(label = state_abbr), color = "orange", hjust = 0, nudge_x = 0.1) +
  theme_classic()
```

```{r, fig.width=12, fig.height=12}
year <- 2020
states_data <- process_states_data(states_election_data, states_pop_income_data, year) %>% 
  arrange(-rep_votes)
election_processed <- process_election_data(election_all, year)

election_processed %>% 
  mutate(vote = ifelse(vote == "Republican", 1, 0)) %>% 
  group_by(stt, inc) %>% 
  summarise(
    vote_rep = sum(vote, na.rm = TRUE) / n()
  ) %>% 
  ungroup() %>% 
  inner_join(stt_dict, by = c("stt" = "stt")) %>% 
  inner_join(states_data %>% select(state_abbr, rep_votes), by = c("state_abbr" = "state_abbr")) %>%
  mutate(state_name = fct_reorder(state_name, rep_votes, .desc = TRUE)) %>% 
  ggplot(aes(group = 1)) + 
  geom_line(aes(x = inc, y = vote_rep, color = "orange")) +
  geom_hline(aes(yintercept = 0.5), color = "grey80", size = 0.2) + 
  scale_x_discrete(labels = c("poor", "", "mid", "", "rich")) +
  scale_y_continuous(labels = scales::label_percent(), breaks = seq(0, 1, 0.5)) +
  scale_color_identity() +
  labs(x = "", y = "") +
  coord_cartesian(ylim = c(0, 1)) +
  facet_wrap(~state_name, ncol = 7) + 
  theme_classic() +
  theme(
    plot.title = element_text(hjust = 0.5, margin = margin(0, 0, 20, 0)),
    plot.caption = element_text(hjust = 0.5, margin = margin(10, 0, 0, 0)),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    strip.text = element_text(size = 10),
    legend.position = "none"
  )

ggsave(here("figures/fig2.png"), width = 12, height = 12)
```

## Useful Information

In IPUMS data, A combination of SAMPLE and SERIAL provides a unique identifier for every household in the IPUMS; the combination of SAMPLE, SERIAL, and PERNUM uniquely identifies every person in the database.

The person-weight variables indicate how many persons in the population are represented by each sample case, so a stateâ€™s population is simply the sum of the PERWT 25values for each respondent in that state. [See here](https://forum.ipums.org/t/how-best-to-aggregate-data-to-a-state-level/1097)
